---
title: Maven学习笔记
date: 2019/02/04 17:26
categories:
- Tool
- Maven
tags:
- Maven
---

# Maven使用

## Maven安装与配置

### 下载与安装

[Maven官网下载地址](http://maven.apache.org/download.cgi)

1. 在如下位置点击下载最新版本`Maven`的压缩包

![Maven下载](http://ww1.sinaimg.cn/large/0062LbXpgy1fx34oirwlfj31890lndi3.jpg)

2. 解压文件得到`apache-maven-xxx`文件夹.`xxx`为版本号

3. 新建环境变量`MAVEN_HOME`,变量值为maven根目录地址

   > 打开环境变量设置的步骤为:
   >
   > - 右击`此电脑`->`属性`->`高级系统设置`->`高级`->`环境变量`
   > - `Win+R`->`sysdm.cpl`->`高级`->`环境变量`

   ![maven环境变量](http://ww1.sinaimg.cn/large/0062LbXpgy1fx34zwb8dnj30tx0iota7.jpg)

4. 编辑环境变量`path`,添加`%MAVEN_HOME%\bin\`

5. 至此,maven安装完毕.打开命令提示符窗口(`Win+R`->`cmd`),输入`mvn -v`查询maven版本,检查maven是否成功安装.成功如图所示![maven成功安装](http://ww1.sinaimg.cn/large/0062LbXpgy1fx358arq3ij30qo0dcmx6.jpg)

### 配置

#### 创建maven仓库

>  如果不自行创建,maven将默认使用`Default: ${user.home}/.m2/repository`作为本地仓库

1. 在想要作为maven仓库的地方创建文件夹`maven-repository`作为maven的本地仓库

2. 打开`maven安装根目录`->`conf`->`settings.xml`

3. 在`<settings>`标签下,找到`<localRepository>`标签.如果没有则自行添加.

   修改值为本地仓库的地址,如`  <localRepository>C:\Maven\apache-maven-3.6.0\maven-repository</localRepository>`

#### 修改下载镜像地址

> 将下载镜像更换为阿里云中央仓库,解决依赖从境外网站下载过慢的问题

1. 打开`maven安装根目录`->`conf`->`settings.xml`

2. 在`<settings>`标签下找到`<mirrors>`标签,添加如下代码

   ```xml
   <mirror>
       <id>nexus-aliyun</id>
       <mirrorOf>central</mirrorOf>
       <name>Nexus aliyun</name>
       <url>http://maven.aliyun.com/nexus/content/groups/public</url>
   </mirror>
   ```

3. 保存即可

#### 针对Maven添加依赖时没有自动提示的解决方案

1. 到Maven仓库官网搜索,点击需要添加的依赖.复制`<dependency>`标签即可.

   > [Maven仓库官网](https://mvnrepository.com/)

#### 在IDEA中配置Maven

1. 打开IDEA,`settings`->`Build,Execution,Deployment`->`Build Tools`->`Maven`
2. 修改`Maven home directory`为maven安装根目录
3. 勾选`User settings file`后的`Override`,然后修改为`安装根目录`->`conf`->`settings.xml`
4. 勾选`Local repository`后的`Override`,然后修改为本地的repository地址

## Maven项目结构

| 项目根目录/ |                                                          |
| ----------- | -------------------------------------------------------- |
| src/        |                                                          |
| main/       | 项目主体根目录                                           |
| java        | 源代码目录                                               |
| resources   | 所需资源目录                                             |
| filters     | 资源过滤文件目录                                         |
| assembly    | 组件的描述配置(如何打包)                                 |
| config      | 配置文件                                                 |
| wepapp      | web应用的目录.<br>WEB-INF,css,js等                       |
| test/       | 项目测试目录根                                           |
| java        | 单元测试java源代码文件                                   |
| resources   | 测试需要用的资源库                                       |
| filters     | c测试资源过滤库                                          |
| site        | Site一些文档                                             |
| target/     | 存放项目构建后的文件和目录.<br>jar,war,编译的class文件等 |
| pom.xml     | MMaven的pom文件                                          |
| LICENSE.TXT | 项目的LISENCE                                            |
| README.TXT  | 项目的README                                             |

## Maven生命周期

> Maven生命周期执行顺序从上至下
>
> **每执行当前指令之前,会把之前(上方)的指令都执行一次**
>
> **每执行当前周期之前会执行之前的生命周期**

### clean生命周期

>  清理项目

|    clean     | 描述                                                         |
| :----------: | :----------------------------------------------------------- |
| `pre-clean`  | 执行清理前需要完成的工作<br>execute processes needed prior to the actual project cleaning |
|   `clean`    | 清理上一次构建生成的文件<br>remove all files generated by the previous build |
| `post-clean` | 执行清理后需要完成的工作<br>execute processes needed to finalize the project cleaning |

### default生命周期

> 构建项目

|  default   | 描述                                                         |
| :--------: | ------------------------------------------------------------ |
| `validate` | 验证工程是否正确,所需要的资源是否可用<br>validate the project is correct and all necessary information is available |
| `compile`  | 编译项目的源代码<br>compile the source code of the project   |
|   `test`   | 使用已编译的测试代码,测试已编译的源代码<br>test the compiled source code using a suitable unit testing framework. These tests should not require the code be packaged or deployed |
| `package`  | 采用编译的代码,并以其可分配格式(如JAR)进行打包<br>take the compiled code and package it in its distributable format, such as a JAR. |
|  `verify`  | 运行所有检查,验证包是否有效且达到质量标准<br>run any checks on results of integration tests to ensure quality criteria are met |
| `install`  | 把包安装在本地的repository中,可以被其他工程作为依赖来使用<br>install the package into the local repository, for use as a dependency in other projects locally |
|  `deploy`  | 在整合或者发布环境下执行,将最终版本的包拷贝到远程的repository,使得其他的开发者或者工程可以共享<br>done in the build environment, copies the final package to the remote repository for sharing with other developers and projects. |

### site生命周期

>  建立和发布项目站点

| site          | 描述                                                         |
| ------------- | ------------------------------------------------------------ |
| `pre-site`    | 生成项目站点之前需要完成的工作<br>execute processes needed prior to the actual project site generation |
| `site`        | 生成项目站点文档<br>generate the project's site documentation |
| `post-site`   | 生成项目站点之后需要完成的工作<br>execute processes needed to finalize the site generation, and to prepare for site deployment |
| `site-deploy` | 将项目站点发布到服务器<br>deploy the generated site documentation to the specified web server |

### Maven默认生命周期

| Default Lifecycle         | 生命周期阶段 | 描述                                                         |
| ------------------------- | ------------ | ------------------------------------------------------------ |
| `validate`                | 验证         | 确保当前配置和 POM 的内容是有效的。这包含对 pom.xml 文件树的验证。 |
| `initialize`              | 初始化       | 在执行构建生命周期的主任务之前可以进行初始化。               |
| `generate-sources`        | 生成源码     | 代码生成器可以开始生成在以后阶段中处理或编译的源代码。       |
| `process-sources`         | 处理源码     | 提供解析、修改和转换源码。常规源码和生成的源码都可以在这里处理。 |
| `generate-resources`      | 生成资源     | 可以生成非源码资源。通常包括元数据文件和配置文件。           |
| `process-resources`       | 处理资源     | 处理非源码资源。修改、转换和重定位资源都能在这阶段发生。     |
| `compile`                 | 编译         | 编译源码。编译过的类被放到目标目录树中。                     |
| `process-classes`         | 处理类       | 处理类文件转换和增强步骤。字节码交织器和常用工具常在这一阶段操作。 |
| `generate-test-sources`   | 生成测试源码 | mojo 可以生成要操作的单元测试代码。                          |
| `process-test-sources`    | 处理测试源码 | 在编译前对测试源码执行任何必要的处理。在这一阶段，可以修改、转换或复制源代码。 |
| `generate-test-resources` | 生成测试资源 | 允许生成与测试相关的（非源码）资源。                         |
| `process-test-resources`  | 处理测试资源 | 可以处理、转换和重新定位与测试相关的资源。                   |
| `test-compile`            | 测试编译     | 编译单元测试的源码。                                         |
| `process-test-classes`    |              | 对测试编译生成的文件做后期处理(需Maven2.0.5及以上)           |
| `test`                    | 测试         | 运行编译过的单元测试并累计结果。                             |
| `prepare-package`         |              | 执行打包前的所有操作(需Maven2.1及以上)                       |
| `package`                 | 打包         | 将可执行的二进制文件打包到一个分布式归档文件中，如 JAR 或 WAR。 |
| `pre-integration-test`    | 前集成测试   | 准备集成测试。这种情况下的集成测试是指在一个受到一定控制的模拟的真 实部署环境中测试代码。这一步能将归档文件部署到一个服务器上执行。 |
| `integration-test`        | 集成测试     | 执行真正的集成测试。                                         |
| `post-integration-test`   | 后集成测试   | 解除集成测试准备。这一步涉及测试环境重置或重新初始化。       |
| `verify`                  | 检验         | 检验可部署归档的有效性和完整性。过了这个阶段，将安装该归档。 |
| `install`                 | 安装         | 将该归档添加到本地 Maven 目录。这一步让其他可能依赖该归档的模块可以使用它。 |
| `deploy`                  | 部署         | 将该归档添加到远程 Maven 目录。这一步让这个工件能为更多的人所用。 |



## Maven环境隔离配置

> 在`pom.xml`中的`<build>`节点下插入`<resources>`节点,在其中添加`<resource>`节点来声明要进行环境分离的`resource`目录.然后在`pom.xml`中`<project>`节点下(与`<build>`同级)增加`<profiles>`节点,通过添加`<profile>`节点来配置不同环境.

1. 在`<build>`节点下插入`<resources>`节点

   ```xml
   <resources>
       <!-- 设置resources资源文件夹目录 -->
       <resource>
           <directory>src/main/resources.${deploy.type}</directory>
           <!-- 排除指定文件 -->
           <excludes>
               <exclude>*.jsp</exclude>
           </excludes>
       </resource>
       <!-- 设置resources资源文件夹目录 -->
       <resource>
           <directory>src/main/resources</directory>
       </resource>
   </resources>
   ```

2. 在`<project>`节点下插入`<profiles>`节点,并配置各个环境的环境标识及其他属性

   ```xml
   <profiles>
       <!-- dev环境 -->
       <profile>
           <id>dev</id>
           <!-- 设置默认使用该环境 -->
           <activation>
               <activeByDefault>true</activeByDefault>
           </activation>
           <!-- 设置环境标识 -->
           <properties>
               <deploy.type>dev</deploy.type>
           </properties>
       </profile>
       <!-- beta环境 -->
       <profile>
           <id>beta</id>
           <!-- 设置环境标识 -->
           <properties>
               <deploy.type>beta</deploy.type>
           </properties>
       </profile>
       <!-- product环境 -->
       <profile>
           <id>prod</id>
           <!-- 设置环境标识 -->
           <properties>
               <deploy.type>prod</deploy.type>
           </properties>
       </profile>
   </profiles>
   ```

3. 创建`resources.<环境标识>`目录,这样便可结合`<resource>`中定义的`${deploy.type}`和`<profile>`中定义的`<properties>`属性值来选择使用哪个环境

   ![resources目录结构.png](https://i.loli.net/2019/02/28/5c77e94283e08.png)

## Maven命令使用

> `-Dmaven.test.skip=true`:跳过测试
>
> `-P${deploy.type}`:使用指定的环境.例如:`mvn package -Pdev`,使用`dev`环境
>
> `mvn help:effective-settings`:查看生效的配置.这里的内容是`settings.xml`中生效的配置,可以用来查看`repository`地址和`mirror`的配置

